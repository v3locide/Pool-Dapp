pipeline{
    agent any
    tools {
        nodejs "NodeJS-22.11.0"
    }
    environment{
        FRONTEND_IMAGE_NAME = "velocide/pool-frontend"
        DOCKER_HUB_CREDENTIALS_ID = "dockerhub_id"
        IMAGE_TAG = "latest"
	K8S_CERTIFICATE = "k8s_cert"
	K8S_SERVER = "'https://master-node:6443"
    }
    stages{
        stage("Fetch"){
            steps{
                git branch: 'pool-docker', url: "https://github.com/v3locide/Pool-Dapp.git"
            }
        }
        stage('Frontend: Setup environment'){
            steps{
                dir("${env.WORKSPACE}/frontend") {
                    sh "npm install --legacy-peer-deps"
                }
            }
        }
        stage('Frontend: Syntax checks'){
            steps{
                dir("${env.WORKSPACE}/frontend") {
                    sh "npm run tsc-build"
                }                
            }
        }
        stage('Frontend: Lint tests'){
            steps{
                dir("${env.WORKSPACE}/frontend") {
                    sh "npm run lint"
                }
            }
        }
                stage("Frontend: Build Docker Image") {
            steps{
                script {
                    dockerFrontendImage = docker.build(FRONTEND_IMAGE_NAME + ":$IMAGE_TAG", "./frontend/")
                }
            }
        }
        stage('Frontend: Push Image') {
            steps{
                script {
                    docker.withRegistry ('', DOCKER_HUB_CREDENTIALS_ID) {
                        dockerFrontendImage.push()
                    }
                }              
            }
        }
		stage('Install Kubectl') {
			steps {
				sh '''
				curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                chmod +x kubectl
                sudo mv kubectl /usr/bin/kubectl
				'''
			}
		}
        stage('Frontend: Deploy to Kubernetes') {
            steps {
                dir("${env.WORKSPACE}/infra") {
                    script {
                        kubeconfig(caCertificate: K8S_CERTIFICATE, credentialsId: 'kubeconfig', serverUrl: K8S_SERVER) {
                            sh '''
                            kubectl apply -f pool-frontend-srv.yaml
                            sleep 1
                            kubectl apply -f pool-frontend-depl.yaml
                  	    '''
                        }
                    }
                }
            }
        }
    }
    post{
        success{
            echo "========pipeline executed successfully========"
        }
        failure{
            echo "========pipeline execution failed========"
        }
    }
}
